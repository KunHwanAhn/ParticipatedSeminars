# 웹 반응성 개선하기
- [Youtube](https://www.youtube.com/watch?v=lmjfSgkpJr8)
- [발표자료](https://speakerdeck.com/kakao/web-baneungseong-gaeseonhagi)

## 목차
- 웹 성능이란?
- 웹 반응성
- 웹 반응성 지표
- 웹 반응성 측정 방법
- 웹 반응성 개선 사례

## 웹 성능이란?
- 로딩 성능을 말하는 경우가 많음
- 사용자는 빠르게 로드되지 않는 페이지는 떠나기 마련, 그렇기에 로딩 성능을 개선하는 것이 중요하다

### Kakao의 성능 측정
- Synthetic Monitoring: 일정한 환경 속에서 성능 측정
- Rear User Monitoring: 유저 환경 속에서 성능 측정

### 성능 개선 지원
- 선응 개선 가이드
- 성능 개선 지원

### 페이지 로드 이후
- 웹이 복잡해지면서 로드보다는 유저와의 Interaction이 중요해짐
- 페이지 전환이 많은 블로그같은 애플리케이션
- 페이지에 머무르면서 다양한 동작을 표현하는 지도와 같은 애플리케이션

## 웹 반응성
- 클릭, 탭, 키 입력과 같은 사용자 인터페이스와 상호작용하는 속도를 의미함

### 웹 반응성 현황
- **70%** 사용자가 일주일에 한 번 이상 끔찍한 반응성을 경험
- 반응성이 나쁜 페이지보다 좋은 페이지 사용량이 **2배 이상**

### RAIL 모델 Response 성능 목표
- 사용자 입력으로부터 100ms 이내 반응

## 웹 반응성 지표
- TBT: Total Blocking Time: 원활한 상호작용
- INP: Interaction to Next Paint: 빠른 피드백
- CLS: Cumulative Layout Shift: 시각적 안정성

### Total Blocking Time
- Long Task: 메인 스레드에서 50ms 이상 실행되는 작업
- Blocking Time: Long Task 중 50ms를 제외한 메인 스레드 점유 시간
- TBT = SUM(Long Task - 50ms)

### Interaction to Next Paint
- 사용자 입력이 발생하고 화면의 변화가 생길때까지의 시간
- Web Vital 수치 중 최근에 추가한 수치

### Cumulative Layout Shift
- 페이지 전체 수명동안 발생하는 예기치 않은 레이아웃 이동 점수

## 웹 반응성 측정 방법
- Lighthouse: 특정 환경에서 로드 성능을 포함한 다양한 성능을 측정
- **Userflow**기능이 추가되어 로드 성능 뿐만 아니라 다른 성느옫 측정 가능

### Lighthouse Userflow
- Navigation: 단일 페이지의 로드 성능 측정
- Snapshot: 사용자 인터렉션 후 페이지의 상태 측정
- Timespan: 임의의 시간동안 사용자 인터렉션 측정

#### Navigation
- 단일 페이지 로드 분석
- LCP와 Speed Index와 같은 페이지 로드 성능 점수 제공
- 카테고리
   - Performance
   - Accessibility
   - Best Practice
   - SEO
   - PWA

#### Snapshot
- 사용자 인터렉션 이후 특정 상태의 페이지 분석
- SPA나 복잡한 폼의 접근성 이슈 확인
- 카테고리
   - Performance
   - Accessibility
   - Best Practice
   - SEO

#### Timespan
- 임의의 시간동안 사용자 인터렉션 분석
- 수명이 긴 페이지, SPA에서 성능 개선 포인트 제공
- 카테고리
   - Performance
   - Best Practice
   - SEO

##### Puppeteer로 Timespan 측정하기
```JavaScript
import puppeteer from 'puppeteer';
import { startFlow } from 'lighthouse/lighthouse-core/fraggle-rock/api.js';

const browser = await puppeteer.launch({ headless: false });
const page = await browser.newPage();

const flow = await startFlow(page, { name: 'daum' });
await flow.startTimespan({ stepName: 'routing' });

// 아래와 같이 UI 시나리오를 매번 정의하는 것이 매우 불편함
await page.goto('https://m.daum.net');
await page.click('#mArticle > nav:nth-child(2) > li.news1 > a > span');
await page.click('#mArticle > nav:nth-child(2) > li.sports > a > span');
await page.click('#mArticle > nav:nth-child(2) > li.enter > a > span');

await flow.endTimespan();
await browser.close();

const report = await flow.generateReport();
const json = await flow.createFlowResult();
```

##### Chrome Devtools Recoder with Puppeteer
- Recorder 기능으로 화면을 기록하고 JSON으로 추출
- Puppeteer, Cypress, Nightwatch 등에서 적용 가능
```JavaScript
import puppeteer from 'puppeteer';
import { startFlow } from 'lighthouse/lighthouse-core/fraggle-rock/api.js';
import { createRunner, PuppeteerRunnerExtension } from '@puppeteer/replay';

const browser = await puppeteer.launch({ headless: false });
const page = await browser.newPage();

const flow = await startFlow(page, { name: 'daum' });
await flow.startTimespan({ stepName: 'routing' });

const runner = await createRunner(
  readJSON('./recording.json'),
  new PuppeteerRunnerExtension(browser, page)
);
await runner.run();

await flow.endTimespan();
await browser.close();

const report = await flow.generateReport();
const json = await flow.createFlowResult();
```

## 웹 반응성 개선 사례

### TBT
- 챗본 주문
- requestAnimationFrame()

### INP
- Kakao 내부에서 제공하는 모티터링 시스템. WPM(Web Performance Monitoring)
- React의 상태 업데이트 2유형. 긴급 업데이트 & 전환 업데이트
   - 긴급 업데이트: 사용자가 즉각적으로 반응하길 바라는 변경사항
   - 전환 업데이트: 사용자가 업데이트 지연을 미리 인지하는 변경사항
- v18 업그레이드 & startTransition()
   - 늦게 업데이트해도 되는 UI는 startTransition()을 사용하여 지연된 업데이트를 하도록 수정

### CLS
- CLS를 발생하는 영역에 미리 Height를 지정하여 영역을 확보함

## Recap
- 로드 성능은 여전히 중요하지만 반응성도 점점 중요해진다
- Lighthouse userflow로 측정하는 반응성
- 반응성 지표별 개선 사례
   - 블로킹 타임 발생 시 강제 리플로우 확인
   - 전체 화면 업데이트 발생 시 중요한 부분 우선 업데이트 진행
   - 레이아웃 시프트는 간단한 작업만으로 쉽게 개선 가능

## Next Step
- 웹 반응성 측정 자동화
- 웹 반응성 측정과 e2e 테스트 통합
- 웹 반응성 개선 가이드
